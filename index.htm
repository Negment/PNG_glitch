<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>PNG Destroyer v9</title>
    <style>
        :root { --accent: #ff0044; --bg: #050505; --panel: #111; --text: #ddd; }
        body { background: var(--bg); color: var(--text); font-family: 'Consolas', 'Monaco', monospace; margin: 0; display: flex; height: 100vh; font-size: 11px; overflow: hidden; }
        
        .sidebar { width: 400px; background: var(--panel); border-right: 1px solid #222; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; box-shadow: 10px 0 30px rgba(0,0,0,0.5); z-index: 10; }
        .viewport { flex-grow: 1; display: flex; align-items: center; justify-content: center; background: #000; padding: 10px; position: relative; }
        
        h1 { font-size: 1.1rem; border-left: 4px solid var(--accent); padding-left: 12px; margin: 0 0 5px 0; letter-spacing: 1px; color: var(--accent); }
        .version { font-size: 9px; color: #555; margin-bottom: 15px; }

        .group { background: #0a0a0a; border: 1px solid #1a1a1a; padding: 12px; border-radius: 2px; }
        .group-title { font-weight: bold; margin-bottom: 8px; color: #888; border-bottom: 1px solid #222; padding-bottom: 4px; text-transform: uppercase; font-size: 10px; }
        
        label { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px; color: #aaa; }
        input[type="range"] { width: 100%; accent-color: var(--accent); cursor: pointer; height: 3px; margin: 8px 0 12px 0; }
        
        canvas { max-width: 100%; max-height: 100%; image-rendering: pixelated; box-shadow: 0 0 50px rgba(255,0,0,0.1); }
        
        .val { color: var(--accent); font-weight: bold; font-family: monospace; }
        
        .btn-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        button { background: #1a1a1a; color: #fff; border: 1px solid #333; padding: 10px; cursor: pointer; font-family: inherit; font-size: 11px; transition: 0.1s; }
        button:hover { background: var(--accent); color: #000; border-color: var(--accent); }
        
        input[type="file"] { font-size: 10px; color: #666; background: #000; padding: 8px; border: 1px solid #222; margin-bottom: 10px; width: 100%; box-sizing: border-box; }
    </style>
</head>
<body>

<div class="sidebar">
    <h1>PNG DESTROYER</h1>
    <div class="version">CORE_LOGIC: REWRITTEN_V9</div>
    
    <input type="file" id="upload" accept="image/*">
    <div class="btn-row">
        <button id="random">RANDOMIZE</button>
        <button id="download">SAVE_PNG</button>
    </div>

    <div class="group">
        <div class="group-title">Filter Cascade</div>
        <label>Trigger Prob. <span class="val" id="v-prob">100</span>%</label>
        <input type="range" id="prob" min="0" max="100" value="100">
        <label>Filter Type (0-4) <span class="val" id="v-type">1</span></label>
        <input type="range" id="type" min="0" max="4" value="1">
        <label>Stability <span class="val" id="v-stable">50</span></label>
        <input type="range" id="stable" min="0" max="300" value="50">
        <label>Stability Jitter <span class="val" id="v-stableJ">0</span></label>
        <input type="range" id="stableJ" min="0" max="200" value="0">
    </div>

    <div class="group">
        <div class="group-title">Spatial Looping</div>
        <label>Block Slide <span class="val" id="v-slide">0</span></label>
        <input type="range" id="slide" min="0" max="1000" value="0">
        <label>Slide Jitter <span class="val" id="v-slideJ">0</span></label>
        <input type="range" id="slideJ" min="0" max="1000" value="0">
        <label>Chunk Size <span class="val" id="v-chunk">10</span></label>
        <input type="range" id="chunk" min="1" max="500" value="10">
    </div>

    <div class="group">
        <div class="group-title">Chromatic Corruption</div>
        <label>RGB Split Loop <span class="val" id="v-rgb">0</span></label>
        <input type="range" id="rgb" min="0" max="200" value="0">
        <label>Pixel Sort Decay <span class="val" id="v-sort">0</span></label>
        <input type="range" id="sort" min="0" max="255" value="0">
        <label>Channel Shuffle <span class="val" id="v-shuffle">0</span></label>
        <input type="range" id="shuffle" min="0" max="5" value="0" step="1">
    </div>

    <div class="group">
        <div class="group-title">Signal Noise</div>
        <label>XOR Bit Shift <span class="val" id="v-bit">0</span></label>
        <input type="range" id="bit" min="0" max="8" value="0">
        <label>Void Offset <span class="val" id="v-void">0</span></label>
        <input type="range" id="void" min="-255" max="255" value="0">
        <label>Death Threshold <span class="val" id="v-inv">255</span></label>
        <input type="range" id="inv" min="0" max="255" value="255">
    </div>
</div>

<div class="viewport">
    <canvas id="canvas"></canvas>
</div>

<script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });
    let originalImageData = null;

    const params = ['prob', 'type', 'stable', 'stableJ', 'slide', 'slideJ', 'chunk', 'sort', 'rgb', 'shuffle', 'bit', 'inv', 'void'];
    const els = {};
    params.forEach(p => {
        els[p] = document.getElementById(p);
        els[p].oninput = () => {
            document.getElementById(`v-${p}`).innerText = els[p].value;
            applyGlitch();
        };
    });

    document.getElementById('upload').onchange = (e) => {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
            const img = new Image();
            img.onload = () => {
                canvas.width = img.width; canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                originalImageData = ctx.getImageData(0, 0, img.width, img.height);
                applyGlitch();
            };
            img.src = ev.target.result;
        };
        reader.readAsDataURL(file);
    };

    document.getElementById('random').onclick = () => {
        params.forEach(p => {
            const min = parseFloat(els[p].min), max = parseFloat(els[p].max);
            els[p].value = Math.floor(Math.random() * (max - min + 1)) + min;
            document.getElementById(`v-${p}`).innerText = els[p].value;
        });
        applyGlitch();
    };

    document.getElementById('download').onclick = () => {
        canvas.toBlob((blob) => {
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `PNG_DESTROYER_V9_${Date.now()}.png`;
            link.click();
        }, 'image/png');
    };

    // ヘルパー: 常に安全に回り込むインデックスを返す
    function getIdx(x, y, w, h) {
        const nx = (x + w * 10) % w;
        const ny = (y + h * 10) % h;
        return (ny * w + nx) * 4;
    }

    function applyGlitch() {
        if (!originalImageData) return;
        const { width, height, data } = originalImageData;
        const out = new ImageData(new Uint8ClampedArray(data), width, height);
        const cfg = {};
        params.forEach(p => cfg[p] = parseFloat(els[p].value));

        // PASS 1: Base Destruction (Filtering, Slide, Sorting)
        for (let y = 0; y < height; y++) {
            const isGlitchRow = Math.random() * 100 <= cfg.prob;
            const slideVal = cfg.slide + (Math.random() - 0.5) * cfg.slideJ;
            const xOffset = Math.floor((Math.floor(y / cfg.chunk) % 2) * slideVal);
            
            for (let x = 0; x < width; x++) {
                const i = (y * width + x) * 4;
                if (!isGlitchRow) continue;

                const ti = getIdx(x + xOffset, y, width, height);
                let r = data[ti], g = data[ti+1], b = data[ti+2];
                
                // PNG Filter with Looping neighbors
                if (cfg.stable !== 0 || cfg.stableJ !== 0) {
                    const currentStable = (cfg.stable + (Math.random() - 0.5) * cfg.stableJ) / 100;
                    const piX = getIdx(x - 1, y, width, height);
                    const piY = getIdx(x, y - 1, width, height);
                    
                    let refR, refG, refB;
                    if (cfg.type == 1) { refR = out.data[piX]; refG = out.data[piX+1]; refB = out.data[piX+2]; }
                    else if (cfg.type == 2) { refR = out.data[piY]; refG = out.data[piY+1]; refB = out.data[piY+2]; }
                    else if (cfg.type == 3) { refR = (out.data[piX]+out.data[piY])/2; refG = (out.data[piX+1]+out.data[piY+1])/2; refB = (out.data[piX+2]+out.data[piY+2])/2; }
                    else if (cfg.type == 4) { refR = Math.abs(out.data[piX]-out.data[piY]); refG = Math.abs(out.data[piX+1]-out.data[piY+1]); refB = Math.abs(out.data[piX+2]-out.data[piY+2]); }
                    else { refR=0; refG=0; refB=0; }

                    r = (r + refR * currentStable) % 256;
                    g = (g + refG * currentStable) % 256;
                    b = (b + refB * currentStable) % 256;
                }

                // Pixel Sort with Looping reference
                if (cfg.sort > 0) {
                    const pi = getIdx(x - 1, y, width, height);
                    const diff = Math.abs(r - out.data[pi]) + Math.abs(g - out.data[pi+1]) + Math.abs(b - out.data[pi+2]);
                    if (diff < cfg.sort) { r = out.data[pi]; g = out.data[pi+1]; b = out.data[pi+2]; }
                }

                // Noise & Void
                if (cfg.bit > 0) { r ^= (r >> cfg.bit); g ^= (g >> cfg.bit); b ^= (b >> cfg.bit); }
                r += cfg.void; g += cfg.void; b += cfg.void;
                if (r > cfg.inv) r = 255 - r; if (g > cfg.inv) g = 255 - g; if (b > cfg.inv) b = 255 - b;

                out.data[i] = r; out.data[i+1] = g; out.data[i+2] = b; out.data[i+3] = 255;
            }
        }

        // PASS 2: Post-Processing (Looping RGB Split & Shuffle)
        if (cfg.rgb !== 0 || cfg.shuffle !== 0) {
            const temp = new Uint8ClampedArray(out.data);
            const shift = Math.floor(cfg.rgb);
            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    const i = (y * width + x) * 4;
                    const ri = getIdx(x + shift, y, width, height);
                    const bi = getIdx(x - shift, y, width, height);
                    
                    let r = temp[ri], g = temp[i+1], b = temp[bi+2];

                    if (cfg.shuffle > 0) {
                        let ch = [r, g, b];
                        if (cfg.shuffle == 1) ch = [r, b, g];
                        else if (cfg.shuffle == 2) ch = [g, r, b];
                        else if (cfg.shuffle == 3) ch = [g, b, r];
                        else if (cfg.shuffle == 4) ch = [b, r, g];
                        else if (cfg.shuffle == 5) ch = [b, g, r];
                        r = ch[0]; g = ch[1]; b = ch[2];
                    }
                    out.data[i] = r; out.data[i+1] = g; out.data[i+2] = b;
                }
            }
        }
        ctx.putImageData(out, 0, 0);
    }
</script>
</body>
</html>
